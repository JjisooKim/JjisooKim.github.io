---
layout: single
title:  "가상쇼핑몰"
---

#### 학습목표
가상 쇼핑몰 고객 주문 데이터 파악하기

 - 현재 상황(데이터로 부터) 파악
 - 모델 수립 혹은 목표 설정

#### 데이터 셋 
 - 온라인 리테일 사이트의 2010/12 - 2011/12간의 주문 기록 데이터
 - 약 500,000건의 데이터 
 - 데이터 출처: [UCI ML Repository](https://archive.ics.uci.edu/ml/datasets/Online+Retail#)

### 01. 가상 쇼핑몰 고객 주문 데이터 확인하기


```python
import numpy as np
import pandas as pd
```


```python
retail = pd.read_csv('C:/Users/User/Downloads/Online Retail.csv')
```

#### 컬럼 확인하기
columns 속성으로 확인

컬럼

- invoiceNo: 주문 번호

- StockCode: 아이템 아이디

- Description: 상품 설명

- Quantity: 상품 주문 수량

- InvoiceDate: 주문 시각

- UnitPrice: 상품 가격(동일한 통화)

- CustomerID: 고객 아이디

- Country: 고객 거주 지역(국가)

  


```python
retail.columns
```


    Index(['InvoiceNo', 'StockCode', 'Description', 'Quantity', 'InvoiceDate',
           'UnitPrice', 'CustomerID', 'Country'],
          dtype='object')



#### 데이터 살펴보기
 1. 데이터 분석의 가장 첫 단계
 2. 데이터를 대략적으로 파악 가능(타입, 저장된 형태)
 3. 데이터 cleansing 전략 수립


```python
retail.head()
```

</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>2.55</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 8:26</td>
      <td>2.75</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
retail.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 541909 entries, 0 to 541908
    Data columns (total 8 columns):
    InvoiceNo      541909 non-null object
    StockCode      541909 non-null object
    Description    540455 non-null object
    Quantity       541909 non-null int64
    InvoiceDate    541909 non-null object
    UnitPrice      541909 non-null float64
    CustomerID     406829 non-null float64
    Country        541909 non-null object
    dtypes: float64(2), int64(1), object(5)
    memory usage: 33.1+ MB



```python
retail.describe()
```


    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>count</td>
      <td>541909.000000</td>
      <td>541909.000000</td>
      <td>406829.000000</td>
    </tr>
    <tr>
      <td>mean</td>
      <td>9.552250</td>
      <td>4.611114</td>
      <td>15287.690570</td>
    </tr>
    <tr>
      <td>std</td>
      <td>218.081158</td>
      <td>96.759853</td>
      <td>1713.600303</td>
    </tr>
    <tr>
      <td>min</td>
      <td>-80995.000000</td>
      <td>-11062.060000</td>
      <td>12346.000000</td>
    </tr>
    <tr>
      <td>25%</td>
      <td>1.000000</td>
      <td>1.250000</td>
      <td>13953.000000</td>
    </tr>
    <tr>
      <td>50%</td>
      <td>3.000000</td>
      <td>2.080000</td>
      <td>15152.000000</td>
    </tr>
    <tr>
      <td>75%</td>
      <td>10.000000</td>
      <td>4.130000</td>
      <td>16791.000000</td>
    </tr>
    <tr>
      <td>max</td>
      <td>80995.000000</td>
      <td>38970.000000</td>
      <td>18287.000000</td>
    </tr>
  </tbody>
</table>
</div>



#### Data cleansing
 - null 데이터 처리
  - CustomerID 
 - Business 로직에 맞지 않은 데이터 처리
  - 음수의 아이템 수량
  - 가격이 0원 


```python
retail.isnull().sum()
```


    InvoiceNo           0
    StockCode           0
    Description      1454
    Quantity            0
    InvoiceDate         0
    UnitPrice           0
    CustomerID     135080
    Country             0
    dtype: int64



##### customerID null 제거


```python
retail=retail[pd.notnull(retail['CustomerID'])]
len(retail)
```


    406829



##### 비지니스 로직에 맞지 않은 데이터 제거
 - 수량, 가격 > 0


```python
retail=retail[retail['Quantity']>0]
retail=retail[retail['UnitPrice']>0]

len(retail)
```


    397884




```python
retail.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 397884 entries, 0 to 541908
    Data columns (total 8 columns):
    InvoiceNo      397884 non-null object
    StockCode      397884 non-null object
    Description    397884 non-null object
    Quantity       397884 non-null int64
    InvoiceDate    397884 non-null object
    UnitPrice      397884 non-null float64
    CustomerID     397884 non-null float64
    Country        397884 non-null object
    dtypes: float64(2), int64(1), object(5)
    memory usage: 27.3+ MB



```python
retail.describe()
```

</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>count</td>
      <td>397884.000000</td>
      <td>397884.000000</td>
      <td>397884.000000</td>
    </tr>
    <tr>
      <td>mean</td>
      <td>12.988238</td>
      <td>3.116488</td>
      <td>15294.423453</td>
    </tr>
    <tr>
      <td>std</td>
      <td>179.331775</td>
      <td>22.097877</td>
      <td>1713.141560</td>
    </tr>
    <tr>
      <td>min</td>
      <td>1.000000</td>
      <td>0.001000</td>
      <td>12346.000000</td>
    </tr>
    <tr>
      <td>25%</td>
      <td>2.000000</td>
      <td>1.250000</td>
      <td>13969.000000</td>
    </tr>
    <tr>
      <td>50%</td>
      <td>6.000000</td>
      <td>1.950000</td>
      <td>15159.000000</td>
    </tr>
    <tr>
      <td>75%</td>
      <td>12.000000</td>
      <td>3.750000</td>
      <td>16795.000000</td>
    </tr>
    <tr>
      <td>max</td>
      <td>80995.000000</td>
      <td>8142.750000</td>
      <td>18287.000000</td>
    </tr>
  </tbody>
</table>
</div>



##### 데이터 타입 변경
 - 메모리 효율화
 - 올바른 데이터 타입 매칭


```python
# 'CustomerID'을 정수형으로(int)
retail['CustomerID']=retail['CustomerID'].astype(np.int32)
retail.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 397884 entries, 0 to 541908
    Data columns (total 8 columns):
    InvoiceNo      397884 non-null object
    StockCode      397884 non-null object
    Description    397884 non-null object
    Quantity       397884 non-null int64
    InvoiceDate    397884 non-null object
    UnitPrice      397884 non-null float64
    CustomerID     397884 non-null int32
    Country        397884 non-null object
    dtypes: float64(1), int32(1), int64(1), object(5)
    memory usage: 25.8+ MB


- 데이터 타입 정리

boolean: T/F

int:정수형

float:실수형




##### 새로운 컬럼 추가
 - Quantity * UnitPrice는 고객의 총 지출 비용(CheckoutPrice)


```python
retail['CheckoutPrice']=retail['UnitPrice']*retail['Quantity']
retail.head()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle
    }


    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>15.30</td>
    </tr>
    <tr>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 8:26</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>22.00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
  </tbody>
</table>
</div>



##### 정제 데이터 저장


```python
retail.to_csv('./OnlineRetailClean.csv')
```



#### 미니 프로젝트를 통한 데이터 분석의 목표

 1. 매출 분석
 2. 고객 분석
  - 우수고객 선별
  - 고객 리텐션 분석
 3. push notification 실행 의사 결정 하기



### 02. 매출, 가장 많이 팔린 아이템 확인하기

##### 학습목표
1. 아이템별 지표 확인하기
2. 시간별 지역별 판매 지표 확인하기


```python
import numpy as np
import pandas as pd
# seaborn
import seaborn as sns
COLORS = sns.color_palette()

%matplotlib inline
```



#### 데이터 로딩

1. 정제된 데이터 사용(retail.csv)


```python
dtypes = {
    'UnitPrice': np.float32,
    'CustomerID': np.int32,
    'Quantity': np.int32
}
retail = pd.read_csv('./OnlineRetailClean.csv', dtype=dtypes)
retail.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>15.30</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 8:26</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>22.00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>4</td>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
  </tbody>
</table>
</div>



#### 날짜 타입 데이터 변환
 - 문자열로 로딩하는 것보다 date/datetime 타입으로 로딩하는 것이 분석에 용이


```python
retail.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 397884 entries, 0 to 397883
    Data columns (total 10 columns):
    Unnamed: 0       397884 non-null int64
    InvoiceNo        397884 non-null int64
    StockCode        397884 non-null object
    Description      397884 non-null object
    Quantity         397884 non-null int32
    InvoiceDate      397884 non-null object
    UnitPrice        397884 non-null float32
    CustomerID       397884 non-null int32
    Country          397884 non-null object
    CheckoutPrice    397884 non-null float64
    dtypes: float32(1), float64(1), int32(2), int64(2), object(4)
    memory usage: 25.8+ MB



```python
#'InvoiceDate'은
retail['InvoiceDate']=pd.to_datetime(retail['InvoiceDate'],infer_datetime_format=True)
retail.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 397884 entries, 0 to 397883
    Data columns (total 10 columns):
    Unnamed: 0       397884 non-null int64
    InvoiceNo        397884 non-null int64
    StockCode        397884 non-null object
    Description      397884 non-null object
    Quantity         397884 non-null int32
    InvoiceDate      397884 non-null datetime64[ns]
    UnitPrice        397884 non-null float32
    CustomerID       397884 non-null int32
    Country          397884 non-null object
    CheckoutPrice    397884 non-null float64
    dtypes: datetime64[ns](1), float32(1), float64(1), int32(2), int64(2), object(3)
    memory usage: 25.8+ MB



#### 해당 기간 동안의 매출

 - 전체 매출
 - 국가별 매출
 - 월별 매출
 - 요일별 매출
 - 시간별 매출



##### 전체 매출 (total_revenue)


```python
total_revenue=retail['CheckoutPrice'].sum()
total_revenue
```




    8911407.904



##### 국가별 매출 (rev_by_countries)


```python
rev_by_countries=retail.groupby('Country').sum()['CheckoutPrice'].sort_values()
rev_by_countries
```




    Country
    Saudi Arabia            1.459200e+02
    Bahrain                 5.484000e+02
    Czech Republic          8.267400e+02
    RSA                     1.002310e+03
    Brazil                  1.143600e+03
    European Community      1.300250e+03
    Lithuania               1.661060e+03
    Lebanon                 1.693880e+03
    United Arab Emirates    1.902280e+03
    Unspecified             2.667070e+03
    Malta                   2.725590e+03
    USA                     3.580390e+03
    Canada                  3.666380e+03
    Iceland                 4.310000e+03
    Greece                  4.760520e+03
    Israel                  7.221690e+03
    Poland                  7.334650e+03
    Austria                 1.019868e+04
    Cyprus                  1.359038e+04
    Italy                   1.748324e+04
    Denmark                 1.895534e+04
    Channel Islands         2.045044e+04
    Singapore               2.127929e+04
    Finland                 2.254608e+04
    Portugal                3.343989e+04
    Norway                  3.616544e+04
    Japan                   3.741637e+04
    Sweden                  3.837833e+04
    Belgium                 4.119634e+04
    Switzerland             5.644395e+04
    Spain                   6.157711e+04
    Australia               1.385213e+05
    France                  2.090240e+05
    Germany                 2.288671e+05
    EIRE                    2.655459e+05
    Netherlands             2.854463e+05
    United Kingdom          7.308392e+06
    Name: CheckoutPrice, dtype: float64




```python
plot = rev_by_countries.plot(kind='bar',color=COLORS[-1],figsize=(20,10))
plot.set_xlabel('Country',fontsize=11)
plot.set_ylabel('Revenue',fontsize=11)
plot.set_title('Revenue by Country',fontsize=13)
plot.set_xticklabels(labels=rev_by_countries.index,rotation=45)
```




    [Text(0, 0, 'Saudi Arabia'),
     Text(0, 0, 'Bahrain'),
     Text(0, 0, 'Czech Republic'),
     Text(0, 0, 'RSA'),
     Text(0, 0, 'Brazil'),
     Text(0, 0, 'European Community'),
     Text(0, 0, 'Lithuania'),
     Text(0, 0, 'Lebanon'),
     Text(0, 0, 'United Arab Emirates'),
     Text(0, 0, 'Unspecified'),
     Text(0, 0, 'Malta'),
     Text(0, 0, 'USA'),
     Text(0, 0, 'Canada'),
     Text(0, 0, 'Iceland'),
     Text(0, 0, 'Greece'),
     Text(0, 0, 'Israel'),
     Text(0, 0, 'Poland'),
     Text(0, 0, 'Austria'),
     Text(0, 0, 'Cyprus'),
     Text(0, 0, 'Italy'),
     Text(0, 0, 'Denmark'),
     Text(0, 0, 'Channel Islands'),
     Text(0, 0, 'Singapore'),
     Text(0, 0, 'Finland'),
     Text(0, 0, 'Portugal'),
     Text(0, 0, 'Norway'),
     Text(0, 0, 'Japan'),
     Text(0, 0, 'Sweden'),
     Text(0, 0, 'Belgium'),
     Text(0, 0, 'Switzerland'),
     Text(0, 0, 'Spain'),
     Text(0, 0, 'Australia'),
     Text(0, 0, 'France'),
     Text(0, 0, 'Germany'),
     Text(0, 0, 'EIRE'),
     Text(0, 0, 'Netherlands'),
     Text(0, 0, 'United Kingdom')]




![png](output_40_1.png)



##### 그래프 유틸 함수


```python
#def plot_bar로 그래프 합수 설정
def plot_bar(df,xlabel,ylabel,title,color=COLORS[0],figsize=(20,10),rotation=45):
    plot = df.plot(kind='bar',color=color,figsize=figsize)
    plot.set_xlabel(xlabel,fontsize=11)
    plot.set_ylabel(ylabel,fontsize=11)
    plot.set_title(title,fontsize=13)
    plot.set_xticklabels(labels=df.index,rotation=rotation)
    
plot_bar(rev_by_countries,'Country','Revenue','Revenue by Country')
```


![png](output_42_0.png)



##### 월별 매출 (rev_by_month)


```python
retail.head()
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>15.30</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>22.00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>4</td>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
  </tbody>
</table>
</div>




```python
retail['InvoiceDate'].sort_values(ascending=False)
#12월 9일이 제일최신 데이터
```




    397883   2011-12-09 12:50:00
    397875   2011-12-09 12:50:00
    397882   2011-12-09 12:50:00
    397870   2011-12-09 12:50:00
    397871   2011-12-09 12:50:00
                     ...        
    4        2010-12-01 08:26:00
    3        2010-12-01 08:26:00
    2        2010-12-01 08:26:00
    1        2010-12-01 08:26:00
    0        2010-12-01 08:26:00
    Name: InvoiceDate, Length: 397884, dtype: datetime64[ns]




```python
def extract_month(date):
    month = str(date.month)
    if date.month <10:
        month = '0'+month
    return str(date.year)+month #

#년도와 월을 문자열로 뽑고 이를 grouping
```


```python
rev_by_month=retail.set_index('InvoiceDate').groupby(extract_month).sum()['CheckoutPrice']
rev_by_month
```




    201012     572713.890
    201101     569445.040
    201102     447137.350
    201103     595500.760
    201104     469200.361
    201105     678594.560
    201106     661213.690
    201107     600091.011
    201108     645343.900
    201109     952838.382
    201110    1039318.790
    201111    1161817.380
    201112     518192.790
    Name: CheckoutPrice, dtype: float64




```python
plot_bar(rev_by_month,'Month','Revenue','Revenue by Month')
```


![png](output_48_0.png)


- 10,11월에 몰려 있음 (일반적으로 12월도 소비가 많은 달 이지만 12월 9일까지만 데이터가 존재)



##### 요일별 매출 (rev_by_dow)

dow:day of week


```python
rev_by_dow = retail.set_index('InvoiceDate').groupby(lambda date:date.dayofweek).sum()['CheckoutPrice']
rev_by_dow
```




    0    1367146.411
    1    1700634.631
    2    1588336.170
    3    1976859.070
    4    1485917.401
    6     792514.221
    Name: CheckoutPrice, dtype: float64



- 5번인 토요일 데이터가 비어 있음을 알 수있음


```python
DAY_OF_WEEK = np.array(['Mon','Tue','Wed','Thur','Fri','Sat','Sun']) 
rev_by_dow.index = DAY_OF_WEEK[rev_by_dow.index]
plot_bar(rev_by_dow,'DOW','Revenue','Revenue by Day of Week')
```


![png](output_53_0.png)


##### 시간별 매출 (rev_by_hour)


```python
rev_by_hour=retail.set_index('InvoiceDate').groupby(lambda date:date.hour).sum()['CheckoutPrice']
plot_bar(rev_by_hour,'hour','revenue','revenue_by_hour')
```


![png](output_55_0.png)


#### Insight from 매출데이터
 - 국가별: 전체 매출의 82%가 UK에서 발생
 - 년도별: 11년도의 가장 많은 주문이 발생한 달 11월(12월의 전체 데이터가 반영이 되진 않았음)
 - 월별: 11, 12월의 판매량이 압도(블랙프라이데이, 사이버먼데이, 크리스마스 휴일)
 - 주간별: 일주일중 목요일까지는 성장세를 보이다가, 이후로 하락(토요일에는 주문X)
 - 시간별: 7시를 시작으로 주문이 시작되어 12시까지 증가세, 15시까지 하락을, 15시 이후 부터 급락)



##### 제품별 metrics
 - Top 10 판매 제품
 - Top 10 매출 제품


```python
#Top 10 판매제품
top_selling = retail.groupby('StockCode').sum()['Quantity'].sort_values(ascending=False)[:10]
top_selling
```




    StockCode
    23843     80995
    23166     77916
    84077     54415
    22197     49183
    85099B    46181
    85123A    36782
    84879     35362
    21212     33693
    23084     27202
    22492     26076
    Name: Quantity, dtype: int32




```python
#Top 10 매출제품
top_revenue = retail.groupby('StockCode').sum()['CheckoutPrice'].sort_values(ascending=False)[:10]
top_revenue
```




    StockCode
    23843     168469.60
    22423     142592.95
    85123A    100603.50
    85099B     85220.78
    23166      81416.73
    POST       77803.96
    47566      68844.33
    84879      56580.34
    M          53779.93
    23084      51346.20
    Name: CheckoutPrice, dtype: float64



##### top 3 아이템의 월별 판매량 추이


```python
retail.set_index('InvoiceDate').groupby(['StockCode',extract_month]).sum()[['Quantity','CheckoutPrice']]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Quantity</th>
      <th>CheckoutPrice</th>
    </tr>
    <tr>
      <th>StockCode</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="5" valign="top">10002</td>
      <td>201012</td>
      <td>224</td>
      <td>190.40</td>
    </tr>
    <tr>
      <td>201101</td>
      <td>337</td>
      <td>286.45</td>
    </tr>
    <tr>
      <td>201102</td>
      <td>50</td>
      <td>42.50</td>
    </tr>
    <tr>
      <td>201103</td>
      <td>23</td>
      <td>19.55</td>
    </tr>
    <tr>
      <td>201104</td>
      <td>189</td>
      <td>160.65</td>
    </tr>
    <tr>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <td rowspan="5" valign="top">POST</td>
      <td>201108</td>
      <td>237</td>
      <td>5185.95</td>
    </tr>
    <tr>
      <td>201109</td>
      <td>279</td>
      <td>5894.50</td>
    </tr>
    <tr>
      <td>201110</td>
      <td>338</td>
      <td>7993.50</td>
    </tr>
    <tr>
      <td>201111</td>
      <td>460</td>
      <td>10349.95</td>
    </tr>
    <tr>
      <td>201112</td>
      <td>123</td>
      <td>2760.00</td>
    </tr>
  </tbody>
</table>
<p>30407 rows × 2 columns</p>
</div>




```python
#Monthly Top 3 판매제품
top_selling = retail.groupby('StockCode').sum()['Quantity'].sort_values(ascending=False)[:3]
top_selling
```




    StockCode
    23843    80995
    23166    77916
    84077    54415
    Name: Quantity, dtype: int32




```python
monthly_top3=retail.set_index('InvoiceDate').groupby(['StockCode',extract_month]).sum()[['Quantity','CheckoutPrice']].loc[top_selling.index]
monthly_top3
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Quantity</th>
      <th>CheckoutPrice</th>
    </tr>
    <tr>
      <th>StockCode</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="9" valign="top">23166</td>
      <td>201101</td>
      <td>74215</td>
      <td>77183.60</td>
    </tr>
    <tr>
      <td>201105</td>
      <td>792</td>
      <td>869.04</td>
    </tr>
    <tr>
      <td>201106</td>
      <td>391</td>
      <td>458.51</td>
    </tr>
    <tr>
      <td>201107</td>
      <td>718</td>
      <td>826.94</td>
    </tr>
    <tr>
      <td>201108</td>
      <td>405</td>
      <td>486.09</td>
    </tr>
    <tr>
      <td>201109</td>
      <td>342</td>
      <td>397.26</td>
    </tr>
    <tr>
      <td>201110</td>
      <td>235</td>
      <td>283.67</td>
    </tr>
    <tr>
      <td>201111</td>
      <td>631</td>
      <td>708.11</td>
    </tr>
    <tr>
      <td>201112</td>
      <td>187</td>
      <td>203.51</td>
    </tr>
    <tr>
      <td>23843</td>
      <td>201112</td>
      <td>80995</td>
      <td>168469.60</td>
    </tr>
    <tr>
      <td rowspan="13" valign="top">84077</td>
      <td>201012</td>
      <td>5139</td>
      <td>1150.47</td>
    </tr>
    <tr>
      <td>201101</td>
      <td>1488</td>
      <td>385.44</td>
    </tr>
    <tr>
      <td>201102</td>
      <td>3457</td>
      <td>795.17</td>
    </tr>
    <tr>
      <td>201103</td>
      <td>3888</td>
      <td>943.20</td>
    </tr>
    <tr>
      <td>201104</td>
      <td>10224</td>
      <td>2281.44</td>
    </tr>
    <tr>
      <td>201105</td>
      <td>4944</td>
      <td>1249.44</td>
    </tr>
    <tr>
      <td>201106</td>
      <td>1920</td>
      <td>533.76</td>
    </tr>
    <tr>
      <td>201107</td>
      <td>3600</td>
      <td>982.56</td>
    </tr>
    <tr>
      <td>201108</td>
      <td>2256</td>
      <td>654.24</td>
    </tr>
    <tr>
      <td>201109</td>
      <td>3462</td>
      <td>985.70</td>
    </tr>
    <tr>
      <td>201110</td>
      <td>8174</td>
      <td>1953.98</td>
    </tr>
    <tr>
      <td>201111</td>
      <td>4500</td>
      <td>1294.20</td>
    </tr>
    <tr>
      <td>201112</td>
      <td>1363</td>
      <td>376.65</td>
    </tr>
  </tbody>
</table>
</div>




```python
plot_bar(monthly_top3['CheckoutPrice'],'Product/Month','Revenue','Top 3 item')
```


![png](output_64_0.png)


### 03. 우수고객 선별하기(가장 소비를 많이 한 고객),고객 코호트 분석

### 학습목표
1. 소비 우수고객 찾기
2. 고객 retention 


코호트: 특정기간내에 비슷한 경험을 한 고객의 집단 (재구매율)


```python
from datetime import datetime
import numpy as np
import pandas as pd
import seaborn as sns
from matplotlib import pyplot as plt

%matplotlib inline
```


```python
dtypes = {
    'UnitPrice': np.float32,
    'CustomerID': np.int32,
    'Quantity': np.int32
}
retail = pd.read_csv('./OnlineRetailClean.csv', dtype=dtypes)
retail['InvoiceDate'] = pd.to_datetime(retail['InvoiceDate'], infer_datetime_format=True)
retail.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>15.30</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>22.00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>4</td>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
  </tbody>
</table>
</div>



#### 우수 고객 확인
 - 구매 횟수 기준
 - 지불 금액 기준


```python
retail.groupby('CustomerID').count()['Quantity'].sort_values(ascending=False)
```




    CustomerID
    17841    7847
    14911    5675
    14096    5111
    12748    4595
    14606    2700
             ... 
    15823       1
    15802       1
    15753       1
    15668       1
    12346       1
    Name: Quantity, Length: 4338, dtype: int64




```python
retail.groupby('CustomerID').sum()['CheckoutPrice'].sort_values(ascending=False)
```




    CustomerID
    14646    280206.02
    18102    259657.30
    17450    194550.79
    16446    168472.50
    14911    143825.06
               ...    
    16878        13.30
    17956        12.75
    16454         6.90
    14792         6.20
    16738         3.75
    Name: CheckoutPrice, Length: 4338, dtype: float64



- Customer 14646,18102와 같은 우수 고객들에게 쿠폰 발송 여부를 생각해 봐야함

#### 사용자 retention 분석
 - 월간 사용자 cohort를 바탕으로 월별 재구매율(retention) 분석하기
 - heatmap으로 한눈에 재구매율을 파악 가능
   -![코호트 분석](https://analyticsmarketing.co.kr/wp-content/uploads/2017/08/%EA%B5%AC%EA%B8%80%EC%95%A0%EB%84%90%EB%A6%AC%ED%8B%B1%EC%8A%A4_%EC%BD%94%ED%98%B8%ED%8A%B8_01.png) 출처: https://analyticsmarketing.co.kr/digital-analytics/google-analytics/1527/
   

#### 사용자 기준으로 최초 구매한 월(month) 연산하기
 - Month : 구매월(일(day)을 무시) 
 - MonthStarted: 사용자가 최초 구매한 달


```python
retail.head()
#오직 년도와 월만 참고
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>15.30</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>22.00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>4</td>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
  </tbody>
</table>
</div>




```python
def get_month_as_datetime(date):
    return datetime(date.year,date.month,1)

retail['Month']=retail['InvoiceDate'].apply(get_month_as_datetime)

retail.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
      <th>Month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>15.30</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>22.00</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <td>4</td>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
      <td>2010-12-01</td>
    </tr>
  </tbody>
</table>
</div>




```python
#사용자가 최초 구매한 달, CustomerID를 기준으로 grouping
month_group=retail.groupby('CustomerID')['Month']
retail['MonthStarted']= month_group.transform(np.min)

retail.tail()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
      <th>Month</th>
      <th>MonthStarted</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>397879</td>
      <td>541904</td>
      <td>581587</td>
      <td>22613</td>
      <td>PACK OF 20 SPACEBOY NAPKINS</td>
      <td>12</td>
      <td>2011-12-09 12:50:00</td>
      <td>0.85</td>
      <td>12680</td>
      <td>France</td>
      <td>10.20</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
    </tr>
    <tr>
      <td>397880</td>
      <td>541905</td>
      <td>581587</td>
      <td>22899</td>
      <td>CHILDREN'S APRON DOLLY GIRL</td>
      <td>6</td>
      <td>2011-12-09 12:50:00</td>
      <td>2.10</td>
      <td>12680</td>
      <td>France</td>
      <td>12.60</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
    </tr>
    <tr>
      <td>397881</td>
      <td>541906</td>
      <td>581587</td>
      <td>23254</td>
      <td>CHILDRENS CUTLERY DOLLY GIRL</td>
      <td>4</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.15</td>
      <td>12680</td>
      <td>France</td>
      <td>16.60</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
    </tr>
    <tr>
      <td>397882</td>
      <td>541907</td>
      <td>581587</td>
      <td>23255</td>
      <td>CHILDRENS CUTLERY CIRCUS PARADE</td>
      <td>4</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.15</td>
      <td>12680</td>
      <td>France</td>
      <td>16.60</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
    </tr>
    <tr>
      <td>397883</td>
      <td>541908</td>
      <td>581587</td>
      <td>22138</td>
      <td>BAKING SET 9 PIECE RETROSPOT</td>
      <td>3</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.95</td>
      <td>12680</td>
      <td>France</td>
      <td>14.85</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
    </tr>
  </tbody>
</table>
</div>



#### 기준이 되는 월과 실제 구매 월의 차이 계산하기
 - 각 구매가 최초 구매로 부터 얼마의 월이 지났는지 연산
 - MonthPassed : 최초 구매월로부터의 월 차이


```python
retail['MonthPassed']=(retail['Month'].dt.year - retail['MonthStarted'].dt.year)*12+ \
    (retail['Month'].dt.month - retail['MonthStarted'].dt.month)
```


```python
retail.tail()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
      <th>Month</th>
      <th>MonthStarted</th>
      <th>MonthPassed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>397879</td>
      <td>541904</td>
      <td>581587</td>
      <td>22613</td>
      <td>PACK OF 20 SPACEBOY NAPKINS</td>
      <td>12</td>
      <td>2011-12-09 12:50:00</td>
      <td>0.85</td>
      <td>12680</td>
      <td>France</td>
      <td>10.20</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
      <td>4</td>
    </tr>
    <tr>
      <td>397880</td>
      <td>541905</td>
      <td>581587</td>
      <td>22899</td>
      <td>CHILDREN'S APRON DOLLY GIRL</td>
      <td>6</td>
      <td>2011-12-09 12:50:00</td>
      <td>2.10</td>
      <td>12680</td>
      <td>France</td>
      <td>12.60</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
      <td>4</td>
    </tr>
    <tr>
      <td>397881</td>
      <td>541906</td>
      <td>581587</td>
      <td>23254</td>
      <td>CHILDRENS CUTLERY DOLLY GIRL</td>
      <td>4</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.15</td>
      <td>12680</td>
      <td>France</td>
      <td>16.60</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
      <td>4</td>
    </tr>
    <tr>
      <td>397882</td>
      <td>541907</td>
      <td>581587</td>
      <td>23255</td>
      <td>CHILDRENS CUTLERY CIRCUS PARADE</td>
      <td>4</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.15</td>
      <td>12680</td>
      <td>France</td>
      <td>16.60</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
      <td>4</td>
    </tr>
    <tr>
      <td>397883</td>
      <td>541908</td>
      <td>581587</td>
      <td>22138</td>
      <td>BAKING SET 9 PIECE RETROSPOT</td>
      <td>3</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.95</td>
      <td>12680</td>
      <td>France</td>
      <td>14.85</td>
      <td>2011-12-01</td>
      <td>2011-08-01</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>




```python

```

#### 기준 월, MonthPassed를 기준으로 고객 카운팅
 - 기준이 되는 월과 그 월로부터 지난 기간의 고객 수를 계산


```python
def get_unique_no(x):
    return len(np.unique(x))

cohort_group= retail.groupby(['MonthStarted','MonthPassed'])
cohort_df= cohort_group['CustomerID'].apply(get_unique_no).reset_index()
cohort_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MonthStarted</th>
      <th>MonthPassed</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2010-12-01</td>
      <td>0</td>
      <td>885</td>
    </tr>
    <tr>
      <td>1</td>
      <td>2010-12-01</td>
      <td>1</td>
      <td>324</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2010-12-01</td>
      <td>2</td>
      <td>286</td>
    </tr>
    <tr>
      <td>3</td>
      <td>2010-12-01</td>
      <td>3</td>
      <td>340</td>
    </tr>
    <tr>
      <td>4</td>
      <td>2010-12-01</td>
      <td>4</td>
      <td>321</td>
    </tr>
    <tr>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <td>86</td>
      <td>2011-10-01</td>
      <td>1</td>
      <td>86</td>
    </tr>
    <tr>
      <td>87</td>
      <td>2011-10-01</td>
      <td>2</td>
      <td>41</td>
    </tr>
    <tr>
      <td>88</td>
      <td>2011-11-01</td>
      <td>0</td>
      <td>323</td>
    </tr>
    <tr>
      <td>89</td>
      <td>2011-11-01</td>
      <td>1</td>
      <td>36</td>
    </tr>
    <tr>
      <td>90</td>
      <td>2011-12-01</td>
      <td>0</td>
      <td>41</td>
    </tr>
  </tbody>
</table>
<p>91 rows × 3 columns</p>
</div>



#### 테이블 피벗
 - pivot 함수를 이용하여 index는 MonthStarted, columns을 MonthPassed로 변경하여 테이블 변경
 - 첫번째 column을 기준으로 100분위 연산


```python
cohort_df = cohort_df.pivot(index='MonthStarted',columns='MonthPassed')
cohort_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead tr th {
        text-align: left;
    }
    
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="13" halign="left">CustomerID</th>
    </tr>
    <tr>
      <th>MonthPassed</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>MonthStarted</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2010-12-01</td>
      <td>885.0</td>
      <td>324.0</td>
      <td>286.0</td>
      <td>340.0</td>
      <td>321.0</td>
      <td>352.0</td>
      <td>321.0</td>
      <td>309.0</td>
      <td>313.0</td>
      <td>350.0</td>
      <td>331.0</td>
      <td>445.0</td>
      <td>235.0</td>
    </tr>
    <tr>
      <td>2011-01-01</td>
      <td>417.0</td>
      <td>92.0</td>
      <td>111.0</td>
      <td>96.0</td>
      <td>134.0</td>
      <td>120.0</td>
      <td>103.0</td>
      <td>101.0</td>
      <td>125.0</td>
      <td>136.0</td>
      <td>152.0</td>
      <td>49.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-02-01</td>
      <td>380.0</td>
      <td>71.0</td>
      <td>71.0</td>
      <td>108.0</td>
      <td>103.0</td>
      <td>94.0</td>
      <td>96.0</td>
      <td>106.0</td>
      <td>94.0</td>
      <td>116.0</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-03-01</td>
      <td>452.0</td>
      <td>68.0</td>
      <td>114.0</td>
      <td>90.0</td>
      <td>101.0</td>
      <td>76.0</td>
      <td>121.0</td>
      <td>104.0</td>
      <td>126.0</td>
      <td>39.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-04-01</td>
      <td>300.0</td>
      <td>64.0</td>
      <td>61.0</td>
      <td>63.0</td>
      <td>59.0</td>
      <td>68.0</td>
      <td>65.0</td>
      <td>78.0</td>
      <td>22.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
cohort_df.iloc[:,0]
```




    MonthStarted
    2010-12-01    885.0
    2011-01-01    417.0
    2011-02-01    380.0
    2011-03-01    452.0
    2011-04-01    300.0
    2011-05-01    284.0
    2011-06-01    242.0
    2011-07-01    188.0
    2011-08-01    169.0
    2011-09-01    299.0
    2011-10-01    358.0
    2011-11-01    323.0
    2011-12-01     41.0
    Name: (CustomerID, 0), dtype: float64




```python
#첫번째 열을 기준으로 한 백분위로 변경
customer_cohort=cohort_df.div(cohort_df.iloc[:,0],axis=0) *100
#소수점 2자리까지 
customer_cohort = customer_cohort.round(decimals=2)

customer_cohort
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead tr th {
        text-align: left;
    }
    
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="13" halign="left">CustomerID</th>
    </tr>
    <tr>
      <th>MonthPassed</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>MonthStarted</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2010-12-01</td>
      <td>100.0</td>
      <td>36.61</td>
      <td>32.32</td>
      <td>38.42</td>
      <td>36.27</td>
      <td>39.77</td>
      <td>36.27</td>
      <td>34.92</td>
      <td>35.37</td>
      <td>39.55</td>
      <td>37.40</td>
      <td>50.28</td>
      <td>26.55</td>
    </tr>
    <tr>
      <td>2011-01-01</td>
      <td>100.0</td>
      <td>22.06</td>
      <td>26.62</td>
      <td>23.02</td>
      <td>32.13</td>
      <td>28.78</td>
      <td>24.70</td>
      <td>24.22</td>
      <td>29.98</td>
      <td>32.61</td>
      <td>36.45</td>
      <td>11.75</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-02-01</td>
      <td>100.0</td>
      <td>18.68</td>
      <td>18.68</td>
      <td>28.42</td>
      <td>27.11</td>
      <td>24.74</td>
      <td>25.26</td>
      <td>27.89</td>
      <td>24.74</td>
      <td>30.53</td>
      <td>6.84</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-03-01</td>
      <td>100.0</td>
      <td>15.04</td>
      <td>25.22</td>
      <td>19.91</td>
      <td>22.35</td>
      <td>16.81</td>
      <td>26.77</td>
      <td>23.01</td>
      <td>27.88</td>
      <td>8.63</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-04-01</td>
      <td>100.0</td>
      <td>21.33</td>
      <td>20.33</td>
      <td>21.00</td>
      <td>19.67</td>
      <td>22.67</td>
      <td>21.67</td>
      <td>26.00</td>
      <td>7.33</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-05-01</td>
      <td>100.0</td>
      <td>19.01</td>
      <td>17.25</td>
      <td>17.25</td>
      <td>20.77</td>
      <td>23.24</td>
      <td>26.41</td>
      <td>9.51</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-06-01</td>
      <td>100.0</td>
      <td>17.36</td>
      <td>15.70</td>
      <td>26.45</td>
      <td>23.14</td>
      <td>33.47</td>
      <td>9.50</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-07-01</td>
      <td>100.0</td>
      <td>18.09</td>
      <td>20.74</td>
      <td>22.34</td>
      <td>27.13</td>
      <td>11.17</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-08-01</td>
      <td>100.0</td>
      <td>20.71</td>
      <td>24.85</td>
      <td>24.26</td>
      <td>12.43</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-09-01</td>
      <td>100.0</td>
      <td>23.41</td>
      <td>30.10</td>
      <td>11.37</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-10-01</td>
      <td>100.0</td>
      <td>24.02</td>
      <td>11.45</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-11-01</td>
      <td>100.0</td>
      <td>11.15</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>2011-12-01</td>
      <td>100.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



#### heatmap 출력하기
 - seaborn의 heatmap 함수로 visualization!


```python
xticks = np.arange(0, 13)
yticks = ['2010/12', '2011/01', '2011/02', '2011/03', '2011/04', '2011/05', '2011/06', '2011/07', '2011/08', '2011/09', '2011/10', '2011/11', '2011/12']

plt.figure(figsize = (15, 8))
sns.heatmap(customer_cohort, 
            annot=True, 
            xticklabels=xticks,
            yticklabels=yticks, 
            fmt='.1f')

```




    <matplotlib.axes._subplots.AxesSubplot at 0x174ce955588>




![png](output_89_1.png)



```python

```

### 04. 데이터 기반으로 의사결정하기 - 푸쉬 노티피케이션 타임


```python
import numpy as np
import pandas as pd
# seaborn
import seaborn as sns
COLORS = sns.color_palette()

%matplotlib inline
```


```python
def plot_bar(df, xlabel, ylabel, title, figsize=(20, 10), color=COLORS[-1], rotation=45):
    plot = df.plot(kind='bar', color=color, figsize=figsize)
    plot.set_xlabel(xlabel, fontsize=10)
    plot.set_ylabel(ylabel, fontsize=10)
    plot.set_title(title, fontsize=12)
    plot.set_xticklabels(labels=df.index, rotation=rotation)
```


```python
dtypes = {
    'UnitPrice': np.float32,
    'CustomerID': np.int32,
    'Quantity': np.int32
}
retail = pd.read_csv('./OnlineRetailClean.csv', dtype=dtypes)
retail['InvoiceDate'] = pd.to_datetime(retail['InvoiceDate'], infer_datetime_format=True)
retail.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
      <th>CheckoutPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0</td>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>15.30</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>22.00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3</td>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
    <tr>
      <td>4</td>
      <td>4</td>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
      <td>20.34</td>
    </tr>
  </tbody>
</table>
</div>



#### 쿠폰 발송을 할때, push를 언제 보내는게 좋을까?
 - 고객에게 쿠폰 발송을 한다고 기획하고, 회의를 한다고 가정해보겠습니다. 
  - A: 쿠폰을 언제보내는게 좋을까요?
  - B: 아침에 출퇴근 시간에 보내는게 좋을까요?
  - C: 점심 먹고 졸린데 그때 보내보죠?
  - D: 흠 자기전에 스마트폰 많이 하던데 그때는 어떨까요?
  - A: 그러면 평균 시간을 내볼까요?
  - K: 아 **데이터**를 확인해보는게 맞지 않을까요? 언제 고객이 주로 주문을 하는지? 


 - 위에서 처럼 실제로 회의를 하다보면 의사결정이 본인/주변의 경험에 의해서 이뤄지는 것을 많이 볼 수 있습니다. 
 - 주문이 이뤄지는 시간을 고려하지 않고 막무가내로 보낸다면 아무 의미가 없고, 추후 같은 이벤트 발생시에도 판단 근거가 없게 됨
 - 현상태에서는 가장 많이 주문이 일어나는 시점에서 하는 것이 가장 직관적인 판단
   - 1. 데이터로 파악
   - 2. 가설 제시
   - 3. 가설 검증
   - 4. 1-3 반복
 - 시간(hour, minute)과 주로 관련되기 때문에 역시 InvoiceDate가 중요한 feature
   


```python
#각 시간 별로 주문량
order_by_hour = retail.set_index('InvoiceDate').groupby(lambda date: date.hour).count()['CustomerID']
order_by_hour
```




    6         1
    7       379
    8      8690
    9     21944
    10    37997
    11    49084
    12    72065
    13    64026
    14    54118
    15    45369
    16    24089
    17    13071
    18     2928
    19     3321
    20      802
    Name: CustomerID, dtype: int64




```python
plot_bar(order_by_hour,'hour','# of orders','Order by Hour')
```


![png](output_98_0.png)


- 12시를 기점으로 12-13시 사이의 시간대



```python
#30분 단위로 살펴보기

#def로 함수생성
def half_an_hour(date):
    minute = ':00'
    if date.minute >30:
        minute= ':30'
    hour = str(date.hour)
    if date.hour <10:
        hour = '0' + hour
    
    return hour + minute
```


```python
order_by_hour_half= retail.set_index('InvoiceDate').groupby(half_an_hour).count()['CustomerID']
order_by_hour_half
```




    06:00        1
    07:30      379
    08:00     3145
    08:30     5545
    09:00     9364
    09:30    12580
    10:00    16950
    10:30    21047
    11:00    18925
    11:30    30159
    12:00    37174
    12:30    34891
    13:00    31131
    13:30    32895
    14:00    26958
    14:30    27160
    15:00    24227
    15:30    21142
    16:00    14316
    16:30     9773
    17:00     8889
    17:30     4182
    18:00     1715
    18:30     1213
    19:00     1534
    19:30     1787
    20:00      802
    Name: CustomerID, dtype: int64




```python
plot_bar(order_by_hour_half,'half an hour','# of orders','order by half an hour')
```


![png](output_102_0.png)


- 12:00-12:30 사이가 가장 많이 주문이 들어옴

=>  30분 단위로 나눔으로써 더욱 정확한 의사결정을 할 수 있는 데이터가 생김



```python
#비율
order_by_hour_half/order_by_hour_half.sum()
```




    06:00    0.000003
    07:30    0.000953
    08:00    0.007904
    08:30    0.013936
    09:00    0.023534
    09:30    0.031617
    10:00    0.042600
    10:30    0.052897
    11:00    0.047564
    11:30    0.075798
    12:00    0.093429
    12:30    0.087691
    13:00    0.078241
    13:30    0.082675
    14:00    0.067753
    14:30    0.068261
    15:00    0.060890
    15:30    0.053136
    16:00    0.035980
    16:30    0.024562
    17:00    0.022341
    17:30    0.010511
    18:00    0.004310
    18:30    0.003049
    19:00    0.003855
    19:30    0.004491
    20:00    0.002016
    Name: CustomerID, dtype: float64



12:00    0.093429 (9%)

12:30    0.087691 (8%)

나머지가 83%



#### 개인화된 push notification

 - 아마존을 필두로, 개인화(personalization)하여 맞춤으로 사용자마다 최적의 솔루션을 찾는것이 트렌드가 됨
 - 사용자별로 소비의 패턴이 다를 수 있기 때문에, 가장 많이 구매한 시간대를 찾아서 해당 시간대에 쿠폰을 발송!



##### 사용자별 각 시간별 주문 량 계산하기


```python
order_count_by_hour = retail.set_index('InvoiceDate').groupby(['CustomerID', lambda date: date.hour]).count()['StockCode']
order_count_by_hour
```




    CustomerID    
    12346       10     1
    12347       8     22
                10    24
                12    47
                13    18
                      ..
    18283       15     1
                16    56
                19    87
    18287       9      3
                10    67
    Name: StockCode, Length: 11205, dtype: int64



'12346 고객이 10시에 1건의 주문을, 12347 고객이 8시에 22건 10시에 24건 ..을 주문하였다'



##### 사용자별 최대 주문 시간 계산하기

 - 가장 많은 주문량을 보인 시간을 계산


```python
#12347 고객을 살펴보자
order_count_by_hour[12347 ]
```




    8     22
    10    24
    12    47
    13    18
    14    60
    15    11
    Name: StockCode, dtype: int64



전체적으로는 12:00-12:30 사이의 주문이 가장 많았지만 12347 고객의 경우 14:00의 주문 건수가 가장 많았다.

- 각 사용자 별로 최댓값을 가지는 시간대를 찾아야 함


```python
#idxmax(): 최댓값을 가지는 인덱스를 반환
idx = order_count_by_hour.groupby('CustomerID').idxmax()
```



##### 해당 시간 indexing


```python
result = order_count_by_hour.loc[idx]
result
```




    CustomerID    
    12346       10      1
    12347       14     60
    12348       19     17
    12349       9      73
    12350       16     17
                     ... 
    18280       9      10
    18281       10      7
    18282       13      7
    18283       14    201
    18287       10     67
    Name: StockCode, Length: 4338, dtype: int64



'12347 고객은   14  시에    60 개의 제품을 주문하였다'


```python
# 시간대 별로 어떤 사용자가 가장 많은 주문능 하였는지 살펴보자.
result.reset_index().groupby('level_1').groups
```




    {7: Int64Index([73, 269, 319, 344, 375, 893, 1667, 2317], dtype='int64'),
     8: Int64Index([  46,   58,   87,  126,  172,  179,  187,  260,  278,  279,
                 ...
                 4000, 4088, 4156, 4167, 4169, 4185, 4259, 4300, 4301, 4302],
                dtype='int64', length=125),
     9: Int64Index([   3,    9,   26,   30,   33,   35,   37,   48,   60,   66,
                 ...
                 4241, 4251, 4265, 4268, 4288, 4291, 4303, 4307, 4320, 4333],
                dtype='int64', length=333),
     10: Int64Index([   0,   11,   21,   27,   28,   41,   42,   45,   49,   51,
                 ...
                 4290, 4292, 4294, 4296, 4297, 4319, 4322, 4330, 4334, 4337],
                dtype='int64', length=510),
     11: Int64Index([  29,   32,   34,   57,   99,  102,  111,  124,  139,  148,
                 ...
                 4172, 4186, 4201, 4214, 4237, 4239, 4253, 4310, 4328, 4332],
                dtype='int64', length=477),
     12: Int64Index([  12,   20,   22,   36,   50,   62,   64,   67,   72,   74,
                 ...
                 4264, 4267, 4274, 4278, 4286, 4287, 4295, 4304, 4315, 4327],
                dtype='int64', length=756),
     13: Int64Index([   7,    8,   14,   16,   18,   23,   43,   44,   52,   59,
                 ...
                 4280, 4298, 4306, 4308, 4311, 4313, 4316, 4325, 4326, 4335],
                dtype='int64', length=672),
     14: Int64Index([   1,    5,   25,   31,   38,   40,   54,   56,   69,   78,
                 ...
                 4228, 4242, 4258, 4272, 4289, 4299, 4309, 4317, 4318, 4336],
                dtype='int64', length=566),
     15: Int64Index([  13,   15,   17,   24,   65,   68,   91,   92,  117,  134,
                 ...
                 4260, 4262, 4276, 4279, 4293, 4305, 4312, 4314, 4323, 4331],
                dtype='int64', length=478),
     16: Int64Index([   4,   10,   19,   39,   53,  128,  133,  157,  192,  210,
                 ...
                 4176, 4244, 4250, 4252, 4254, 4271, 4281, 4283, 4284, 4321],
                dtype='int64', length=231),
     17: Int64Index([   6,   63,   89,  153,  185,  261,  283,  289,  321,  426,
                 ...
                 4054, 4057, 4060, 4063, 4090, 4138, 4144, 4151, 4153, 4329],
                dtype='int64', length=122),
     18: Int64Index([  80,  320,  453,  637,  767,  862,  879, 1128, 1326, 1378, 1498,
                 1519, 1624, 1652, 1758, 1768, 1844, 2879, 3198, 3467, 3511, 3537,
                 3767, 3802, 3820, 3837, 4072, 4077, 4079, 4273],
                dtype='int64'),
     19: Int64Index([   2,   47,  667, 1589, 1591, 1639, 1730, 1776, 1928, 2044, 2448,
                 2548, 2876, 3002, 3047, 3261, 3274, 3479, 3556, 3652, 3685, 3789,
                 3812, 4324],
                dtype='int64'),
     20: Int64Index([1646, 1943, 3804, 3838, 4050, 4110], dtype='int64')}



### 05. 로그데이터를 파악하여 고객 이탈 페이지 확인하기

### 학습목표
1. 로그데이터로 고객 이탈 페이지 확인하기


```python
import pandas as pd
import numpy as np
```


```python

```

#### 웹서버 로그 데이터
 - 웹서버에 클라이언트로의 요청(request) 전달 시, 해당 요청에 대한 정보(ip, 시각, 방문 페이지 등등)를 기록하는 파일
 - 기록되는 로그의 포맷(format)의 표준이 있으나 설정으로 포맷 변경 가능
 - 로그 데이터는 주로 웹 서버의 디버깅, 데이터 분석 등의 형태로 사용 됨
 - 예제에서 사용하는 형식
   - ip 세션아이디 사용자식별자 시각 요청 페이지 상태코드 바이트사이즈
   ```
   1.0.0.1 sessionid user59 [16/Dec/2019:02:00:08] GET /checkout 200 1508
   ```


```python
logs = pd.read_csv('web.log', 
                   sep='\s',
                   engine='python',
                   names=['ip', 'session_id', 'user_id', 'datetime', 'request', 'url', 'status', 'bytesize'])

logs.head()
```


```python

```

#### 날짜 형식 변환


```python

```

#### 어떤 페이지에서 고객이 이탈을 할까?
 - 고객 이탈 페이지를 알면 해당 페이지를 분석하여 고객을 최종 단계로 더 많이 유도 가능
 - 대부분의 경우 다음 스텝으로 넘어갈때의 장벽이(신용카드 입력, 정보 입력 등등) 높은 경우가 해당 됨


```python

```

#### 퍼널 스텝 dataframe 생성
 - 스텝 순서(ordering) 등을 명시하기 위해 사용


```python

```

#### session, url 로 grouping
 - user_id가 아닌 session을 기준으로 삼는 이유는 동일한 유저가 다른 세션으로 접속한 경우도 다른 경우로 간주해야 하기 때문
 - session_id와 url로 그루핑하여 가장 시간대가 빠른 해당 이벤트에 대해 추출


```python

```

#### 퍼널 테이블 생성
 - 각 퍼널의 스텝이 순서대로 columns으로 오도록 변경


```python

```

#### 퍼널 카운트 계산
 - 각 퍼널 스텝별 카운트 계산


```python

```

#### 평균 시간 계산
 - 각 퍼널별 소요 시간 계산


```python

```


```python

```


```python

```


```python

```


```python

```


```python

```


```python

```


```python

```


```python

```


```python

```
